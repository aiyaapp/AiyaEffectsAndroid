package com.aiyaapp.aiya;

import android.content.Context;
import android.content.SharedPreferences;
import android.content.res.AssetManager;

import com.aiyaapp.aiya.base.IFaceTracker;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

/**
 * ç”ã„¤ºæµœé¸¿„å“¥‰ç‘°¾ç‚è§„Ÿãƒ¦‰æ’…¼Œåô•§äº’ææ¸š›ç¼™å…æœµ»–éœ€ç‘•ç”ã„¥ˆé¢æ±‰è„æ­Œ¯†åˆô²š„å¦¯â€³—æ©›ç›Œæµ£è·¨”¨
 *
 * @author wuwang
 */
public class AiyaTracker implements IFaceTracker {

  private long nativeId = 0;

  public static final int IMAGE_TYPE_Y = 1;
  public static final int IMAGE_TYPE_RGBA = 2;

  private final Object LOCK = new Object();

  private Context mContext;
  private SharedPreferences mSp;

  public AiyaTracker(Context context, int min_face_size) {
    this.mContext = context.getApplicationContext();
    mSp = this.mContext.getSharedPreferences(mContext.getPackageName(), Context.MODE_PRIVATE);
    init(min_face_size);
  }

  public int track(int type, byte[] input, int width, int height, float[] output) {
    return _track(nativeId, type, input, width, height, output);
  }

  public int track(int type, byte[] input, int width, int height) {
    return _track(nativeId, type, input, width, height);
  }

  @Override
  protected void finalize() throws Throwable {
    release();
    super.finalize();
  }

  // @Override
  public int init(int min_face_size) {
    synchronized (LOCK) {
      if (nativeId == 0) {
        nativeId = _createNativeObj(0);
        // æ¶“åŒç‰ˆæœô‘ô•«ƒç•Œ”ã„¥ˆæ‰®š„å¦¯â€³‹æ–‡æµ æœµ¸åŒé”›Œæ‰€æµ ãƒ©œ€ç‘•åˆã‚†–ô’®‰ˆæœô‘˜¼Œæ¶“åŒç‰ˆæœô‘æ°¨ç‘•åˆ é™ã‚†‰åŸæœ‰çš„å¦¯â€³‹æ–‡æµ ¶
        // åç¼ô’¯ô“æ´•ç‚çä»‹‡æ”ô•©Œç›å­˜ãƒ¨ô”¾å–assetsæ¶“ô’®š„å¦¯â€³‹é”›Œçå˜¸éœ€ç‘•æ©™æ¶“€å§ãƒ¤º†
        File folder = mContext.getExternalFilesDir(null);
        if (folder == null) {
          folder = mContext.getFilesDir();
        }
        if (folder != null) {
          String dstPath = folder.getAbsolutePath() + "/config";
          int lastTrackCode = mSp.getInt("trackVersionCode", 1);
          if (lastTrackCode != getVersionCode()) {
            deleteFile(new File(dstPath));
            mSp.edit()
                .putString("trackVersionName", getVersionName())
                .putInt("trackVersionCode", getVersionCode())
                .apply();
          }

          // TODO åˆã‚†–ô’­–‡æµ èˆµ˜ô•¨ôˆš­˜åœô‹ ¼Œæ¶“ç€›˜åœã„¥æ°¨æ‹ç–¯´æ©‡å»
          if (!new File(dstPath).exists()) {
            copyFileFromAssets("config", dstPath, mContext.getAssets());
          }
          return _init(nativeId, min_face_size, dstPath);
        } else {
          return -1;
        }
      }
    }
    return 0;
  }

  /**
   * èå³°–è¤°“å‰å¦¯â€³—çš„ç‰ˆæœô‘å”¬ç 
   *
   * @return ç‰ˆæœô‘å”¬ç 
   */
  public int getVersionCode() {
    return _getVersionCode();
  }

  /**
   * èå³°–è¤°“å‰å¦¯â€³—çš„ç‰ˆæœô‘
   *
   * @return ç‰ˆæœô‘
   */
  public String getVersionName() {
    return _getVersionName();
  }

  private boolean deleteFile(File file) {
    if (file.exists()) {
      if (file.isDirectory()) {
        for (File f : file.listFiles()) {
          deleteFile(f);
        }
      } else {
        if (!file.delete()) {
          return false;
        }
      }
    }
    return true;
  }

  private boolean copyFileFromAssets(String src, String dst, AssetManager manager) {
    try {
      String[] files = manager.list(src);
      if (files.length > 0) { // æ¿¡‚æœæ˜ô•©–‡æµ è·ºã™
        File folder = new File(dst);
        if (!folder.exists()) {
          boolean b = folder.mkdirs();
          if (!b) {
            return false;
          }
        }
        for (String fileName : files) {
          if (!copyFileFromAssets(
              src + File.separator + fileName, dst + File.separator + fileName, manager)) {
            return false;
          }
        }
      } else { // æ¿¡‚æœæ˜ô•©–‡æµ ¶
        if (!copyAssetsFile(src, dst, manager)) {
          return false;
        }
      }
    } catch (IOException e) {
      return false;
    }
    return true;
  }

  private boolean copyAssetsFile(String src, String dst, AssetManager manager) {
    InputStream in;
    OutputStream out;
    try {
      File file = new File(dst);
      if (!file.exists()) {
        in = manager.open(src);
        out = new FileOutputStream(dst);
        byte[] buffer = new byte[4 * 1024];
        int read;
        while ((read = in.read(buffer)) != -1) {
          out.write(buffer, 0, read);
        }
        out.flush();
        out.close();
        in.close();
      }
    } catch (Exception e) {
      return false;
    }
    return true;
  }

  @Override
  public long getFaceDataID() {
    return _getFaceDataID();
  }

  @Override
  public String getType() {
    return "FaceData";
  }

  @Override
  public long getId() {
    return nativeId;
  }

  @Override
  public int release() {
    int ret = 0;
    synchronized (LOCK) {
      if (nativeId != 0) {
        ret = _release(nativeId);
        nativeId = 0;
      }
    }
    return ret;
  }

  public static native long requestId();

  private static native long _createNativeObj(int type);

  private static native long _getFaceDataID();

  private static native int _init(long id, int min_face_size, String data);

  private static native int _track(
      long id, int type, byte[] input, int width, int height, float[] output);

  private static native int _track(long id, int type, byte[] input, int width, int height);

  private static native int _release(long id);

  private static native int _getVersionCode();

  private static native String _getVersionName();

  static {
    System.loadLibrary("AyCoreSdk");
    System.loadLibrary("AyCoreSdkJni");
    System.loadLibrary("AyTrack");
  }
}
